<?php
/**
 * @file
 * Tests for Simple LDAP User module.
 */

abstract class SimpleLdapUserWebTestCase extends DrupalWebTestCase {

  public function setUp() {
    parent::setUp(array('simple_ldap', 'simple_ldap_user', 'simple_ldap_test'));
  }

  /**
   * Verify that a user is unable to log in.
   */
  public function drupalNoLogin(stdClass $user) {
    if ($this->loggedInUser) {
      $this->drupalLogout();
    }

    $edit = array(
      'name' => $user->name,
      'pass' => $user->pass_raw,
    );
    $this->drupalPost('user', $edit, t('Log in'));

    // Verify that the user was unable to log in.
    $pass = $this->assertNoLink(t('Log out'), 0, t('User %name unable to log in.', array('%name' => $user->name)), t('User login'));

    if (!$pass) {
      $this->loggedInUser = $user;
    }
  }

  /**
   * Log in with User 1.
   */
  public function drupalUser1Login() {
    // Load password hashing API.
    require_once DRUPAL_ROOT . '/' . variable_get('password_inc', 'includes/password.inc');

    // Generate a random password.
    $pass = hash('sha256', microtime());

    // Update user-1's password in the database.
    db_query("UPDATE {users} SET pass = :hash WHERE uid = 1", array(':hash' => user_hash_password($pass)));

    // Load user-1.
    $admin_user = user_load(1);

    // Set the password.
    $admin_user->pass_raw = $pass;

    // Log in.
    $this->drupalLogin($admin_user);
  }

}

class SimpleLdapUserAuthenticationWebTestCase extends SimpleLdapUserWebTestCase {

  public static function getInfo() {
    return array(
      'name' => 'Authentication',
      'description' => 'Tests that an LDAP user can authenticate to Drupal with the correct LDAP credentials.',
      'group' => 'Simple LDAP User',
    );
  }

  /**
   * Test user authentication.
   *
   * #15 - Test that user can authenticate to Drupal using LDAP credentials.
   * #16 - User cannot authenticate to Drupal using incorrect credentials.
   */
  public function testAuthentication() {
    // Load configuration variables.
    $test_user = variable_get('simple_ldap_test_user');
    $attribute_name = variable_get('simple_ldap_user_attribute_name');

    // Initialize a user account object.
    $account = new stdClass();
    $account->name = $test_user[$attribute_name];

    debug('A user exists in LDAP but not in Drupal.');

    // Verify that the test user exists in LDAP.
    $ldap_user = new SimpleLdapUser($test_user[$attribute_name]);
    $this->assertTrue($ldap_user->exists, t('The test user was found in LDAP.'));

    // Verify that the test user does not exist in Drupal.
    $drupal_user = user_load_by_name($test_user[$attribute_name]);
    $this->assertIdentical($drupal_user, FALSE, t('The test user does not exist in Drupal.'));

    // Verify that the user cannot log in with incorrect credentials.
    $account->pass_raw = $test_user['pass'] . 'invalid';
    $this->drupalNoLogin($account);

    // Verify that the user still does not exist in Drupal.
    $drupal_user = user_load_by_name($test_user[$attribute_name]);
    $this->assertIdentical($drupal_user, FALSE, t('The test user still does not exist in Drupal.'));

    // Verify that the user can log in.
    $account->pass_raw = $test_user['pass'];
    $this->drupalLogin($account);

    // Verify that the Drupal user was created during authentication.
    $drupal_user = user_load_by_name($test_user[$attribute_name]);
    $this->assertNotIdentical($drupal_user, FALSE, t('The test user was created in Drupal.'));

    debug('A user exists in both Drupal and LDAP.');

    // Verify again that the user can log in, now that the account exists in
    // both Drupal and LDAP.
    $this->drupalLogin($account);

    // Verify that the user cannot log in with incorrect credentials.
    $account->pass_raw = $test_user['pass'] . 'invalid';
    $this->drupalNoLogin($account);

    debug('A user exists in Drupal but not in LDAP.');

    // Create a new Drupal user that is not in LDAP.
    $account = $this->drupalCreateuser(array());

    // Verify that the user does not exist in LDAP by random chance.
    $ldap_user = new SimpleLdapUser($account->name);
    $this->assertFalse($ldap_user->exists, t('The user account does not exist in LDAP.'));

    // Verify that the user cannot log in.
    $this->drupalNoLogin($account);
  }

}

class SimpleLdapUserFilterWebTestCase extends SimpleLdapUserWebTestCase {

  public static function getInfo() {
    return array(
      'name' => 'Search filter',
      'description' => 'Tests the LDAP search filter, if it is configured.',
      'group' => 'Simple LDAP User',
    );
  }

  /**
   * Test the configured search filter.
   *
   * #26 - Verify that user not in active group cannot authenticate.
   */
  public function testFilter() {
    // Load configuration variables.
    $inactive_user = variable_get('simple_ldap_test_inactive_user');
    $attribute_name = variable_get('simple_ldap_user_attribute_name');
    $filter = variable_get('simple_ldap_user_filter');

    // Only run the tests if there is a filter configured.
    if (empty($filter)) {
      $this->assertTrue(TRUE, t('There is no search filter configured.'));
    }
    else {
      // Initialize a user account object.
      $account = new stdClass();
      $account->name = $inactive_user[$attribute_name];
      $account->pass_raw = $inactive_user['pass'];

      // Verify that the user does not exist per the configured search filter.
      $ldap_user = new SimpleLdapUser($account->name);
      $this->assertFalse($ldap_user->exists, t('The user does not exist according to the LDAP search filter.'));

      // Verify that the test user does not exist in Drupal.
      $drupal_user = user_load_by_name($inactive_user[$attribute_name]);
      $this->assertIdentical($drupal_user, FALSE, t('The test user does not exist in Drupal.'));

      // Attempt to log in anyway.
      $this->drupalNoLogin($account);

      // Clear the search filter.
      variable_set('simple_ldap_user_filter', '');

      // Verify that the user now exists.
      $ldap_user = new SimpleLdapUser($account->name);
      $this->assertTrue($ldap_user->exists, t('The user exists in the LDAP directory.'));

      // Attempt to log in again.
      $this->drupalLogin($account);

      // Verify that the user now exists in Drupal.
      $drupal_user = user_load_by_name($inactive_user[$attribute_name]);
      $this->assertNotIdentical($drupal_user, FALSE, t('The test user was created in Drupal.'));

      // Now that the user exists in Drupal, reset the filter, and check again.
      variable_set('simple_ldap_user_filter', $filter);

      // Verify that the user does not exist per the configured search filter.
      $ldap_user = new SimpleLdapUser($account->name);
      $this->assertFalse($ldap_user->exists, t('The user does not exist according to the LDAP search filter.'));

      // Attempt to log in anyway.
      $this->drupalNoLogin($account);
    }
  }

}

class SimpleLdapUserUserOneLoginWebTestCase extends SimpleLdapUserWebTestCase {

  public static function getInfo() {
    return array(
      'name' => 'User 1 login',
      'description' => 'Tests whether User 1 can log in, skipping LDAP authentication.',
      'group' => 'Simple LDAP User',
    );
  }

  /**
   * Test User 1 authentication.
   *
   * #20 - Log into Drupal as User 1 avoids LDAP.
   */
  public function testUserOneLogin() {
    // Load user-1.
    $admin_user = user_load(1);

    // Verify that user-1 does not exist in LDAP.
    $ldap_user = new SimpleLdapUser($admin_user->name);
    $this->assertFalse($ldap_user->exists, t('User 1 does not exist in LDAP.'));

    // Attempt to log in.
    $this->drupalUser1Login();

    // Verify that user-1 does not exist in LDAP.
    $ldap_user = new SimpleLdapUser($admin_user->name);
    $this->assertFalse($ldap_user->exists, t('User 1 does not exist in LDAP.'));
  }

}

class SimpleLdapUserUserChangesProfileWebTestCase extends SimpleLdapUserWebTestCase {

  public static function getInfo() {
    return array(
      'name' => 'User can modify profile',
      'description' => 'Tests whether a user can modify their profile, and that the changes are synchronized to LDAP.',
      'group' => 'Simple LDAP User',
    );
  }

  /**
   * User edits profile information.
   *
   * #18 User can change their email address and LDAP is updated appropriately
   * #23 User changes last name and it is changed in LDAP
   * #30 User changes first name and it is changed in ldap
   *
   * @todo finish this.
   */
  public function testUserChangesProfile() {
    // Load configuration variables.
    $test_user = variable_get('simple_ldap_test_user');
    $attribute_name = variable_get('simple_ldap_user_attribute_name');

    // Initialize a user account object.
    $account = new stdClass();
    $account->name = $test_user[$attribute_name];
    $account->pass_raw = $test_user['pass'];

    // Log in user. This should create/sync an LDAP user (tested elsewhere)
    $this->drupalLogin($account);
    $drupal_user = user_load_by_name($test_user[$attribute_name]);

    $edit['current_pass'] = $test_user['pass'];
//    $edit['mail'] = $drupal_user->mail . 'modified';
    $edit['field_last_name[und][0][value]'] = $this->randomName();

    $map = simple_ldap_user_map();
    foreach ($map as $field) {
      switch($field['type']) {
        case 'field':
          $edit[$field['drupal'] . '[und][0][value]'] = $this->randomName();
          break;
        case 'default':
        default:
          $edit[$field['drupal']] = $this->randomName();
      }
    }

    // Submit user edit form.
    $this->drupalPost('user/' . $drupal_user->uid . '/edit', $edit, 'Save');

  }
}

class SimpleLdapUserRegistrationTestCase extends SimpleLdapUserWebTestCase {

  public static function getInfo() {
    return array(
      'name' => 'User registration',
      'description' => 'Test registration of user under different configurations.',
      'group' => 'Simple LDAP User',
    );
  }

  /**
   * Generate random data for user registration form.
   */
  public function formData(&$name, &$mail) {
    $edit['name'] = $name = $this->randomName();
    $edit['mail'] = $mail = $edit['name'] . '@example.com';

    $map = simple_ldap_user_map();
    foreach ($map as $attribute) {
      if ($attribute['required']) {
        $edit[$attribute['drupal'] . '[und][0][value]'] = $this->randomName();
      }
    }

    return $edit;
  }

  public function testRegistrationWithEmailVerification() {
    // Require e-mail verification.
    variable_set('user_email_verification', TRUE);

    // Set registration to administrator only.
    variable_set('user_register', USER_REGISTER_ADMINISTRATORS_ONLY);
    $this->drupalGet('user/register');
    $this->assertResponse(403, t('Registration page is inaccessible when only administrators can create accounts.'));

    // Allow registration by site visitors without administrator approvial.
    variable_set('user_register', USER_REGISTER_VISITORS);
    $edit = $this->formData($name, $mail);
    $this->drupalPost('user/register', $edit, t('Create new account'));
    $this->assertText(t('A welcome message with further instructions has been sent to your e-mail address.'), t('User registered successfully.'));
    $accounts = user_load_multiple(array(), array('name' => $name, 'mail' => $mail));
    $new_user = reset($accounts);
    $this->assertTrue($new_user->status, t('New account is active after registration.'));
    $ldap_user = new SimpleLdapUser($name);
    $this->assertTrue($ldap_user->exists, t('New account was provisioned to LDAP.'));

    // Allow registration by site visitors, but require administrator approval.
    variable_set('user_register', USER_REGISTER_VISITORS_ADMINISTRATIVE_APPROVAL);
    $edit = $this->formData($name, $mail);
    $this->drupalPost('user/register', $edit, t('Create new account'));
    $accounts = user_load_multiple(array(), array('name' => $name, 'mail' => $mail));
    $new_user = reset($accounts);
    $this->assertFalse($new_user->status, t('New account is blocked until approved by an administrator.'));
  }

  public function testRegistrationWithoutEmailVerification() {
    // Don't require e-mail verification.
    variable_set('user_email_verification', FALSE);

    // Allow registration by site visitors without administrator approval.
    variable_set('user_register', USER_REGISTER_VISITORS);
    $edit = $this->formData($name, $mail);

    // Try entering a mismatching password.
    $edit['pass[pass1]'] = '99999.0';
    $edit['pass[pass2]'] = '99999';
    $this->drupalPost('user/register', $edit, t('Create new account'));
    $this->assertText(t('The specified passwords do not match.'), t('Typing mismatched passwords displays an error message.'));

    // Enter a correct password.
    $edit['pass[pass1]'] = $new_pass = $this->randomName();
    $edit['pass[pass2]'] = $new_pass;
    $this->drupalPost('user/register', $edit, t('Create new account'));
    $accounts = user_load_multiple(array(), array('name' => $name, 'mail' => $mail));
    $new_user = reset($accounts);
    $this->assertText(t('Registration successful. You are now logged in.'), t('Users are logged in after registering.'));
    $this->drupalLogout();

    // Allow registration by site visitors, but require administrator approval.
    variable_set('user_register', USER_REGISTER_VISITORS_ADMINISTRATIVE_APPROVAL);
    $edit = $this->formData($name, $mail);
    $edit['pass[pass1]'] = $pass = $this->randomName();
    $edit['pass[pass2]'] = $pass;
    $this->drupalPost('user/register', $edit, t('Create new account'));
    $this->assertText(t('Thank you for applying for an account. Your account is currently pending approval by the site administrator.'), t('Users are notified of pending approval'));
    $ldap_user = new SimpleLdapUser($name);
    $this->assertFalse($ldap_user->exists, t('New account has not been provisioned to LDAP.'));

    // Try to login before administrator approval.
    $auth = array(
      'name' => $name,
      'pass' => $pass,
    );
    $this->drupalPost('user/login', $auth, t('Log in'));
    $this->assertText(t('The username @name has not been activated or is blocked.', array('@name' => $name)), t('User cannot login yet.'));

    // Activate the new account.
    $accounts = user_load_multiple(array(), array('name' => $name, 'mail' => $mail));
    $new_user = reset($accounts);
    $this->drupalUser1Login();
    $edit = array(
      'status' => 1,
    );
    $this->drupalPost('user/' . $new_user->uid . '/edit', $edit, t('Save'));
    $ldap_user = new SimpleLdapUser($new_user->name);
    $this->assertTrue($ldap_user->exists, t('New account has been provisioned to LDAP.'));
    $this->drupalLogout();

    // Login after administrator approval.
    $this->drupalPost('user/login', $auth, t('Log in'));
    $this->assertText(t('Member for'), t('User can log in after administrator approval.'));
  }

  public function testRegistrationValues() {
    // Get simple_ldap_user config.
    $attribute_name = variable_get('simple_ldap_user_attribute_name');
    $attribute_mail = variable_get('simple_ldap_user_attribute_mail');

    // Allow registration by site visitors without administrator approval.
    variable_set('user_register', USER_REGISTER_VISITORS);

    // Don't require e-mail verification.
    variable_set('user_email_verification', FALSE);

    // Set the default timezone to Brussels.
    variable_set('configurable_timezones', 1);
    variable_set('date_default_timezone', 'Europe/Brussels');

    // Verify that the required mapped fields show up on the registration form.
    $this->drupalGet('user/register');
    $map = simple_ldap_user_map();
    foreach ($map as $field) {
      if ($field['required'] && $field['type'] == 'field') {
        $this->assertText($field['drupal'], t(':field appears on the user registration form', array(':field' => $field['drupal'])));
      }
    }

    // Submit registration form.
    $edit = $this->formData($name, $mail);
    $edit['pass[pass1]'] = $new_pass = $this->randomName();
    $edit['pass[pass2]'] = $new_pass;
    $this->drupalPost(NULL, $edit, t('Create new account'));

    // Load the Drupal user.
    $accounts = user_load_multiple(array(), array('name' => $name, 'mail' => $mail));
    $new_user = reset($accounts);

    // Load the LDAP user.
    $ldap_user = new SimpleLdapUser($name);

    // Check user fields.
    $this->assertEqual($new_user->name, $name, t('Drupal username matches.'));
    $this->assertEqual($ldap_user->{$attribute_name}[0], $name, t('LDAP username matches.'));

    $this->assertEqual($new_user->mail, $mail, t('Drupal e-mail address matches.'));
    $this->assertEqual($ldap_user->{$attribute_mail}[0], $mail, t('LDAP e-mail address matches.'));

    foreach ($map as $field) {
      if ($field['required'] && $field['type'] == 'field') {
        $this->assertEqual($new_user->{$field['drupal']}[LANGUAGE_NONE][0]['value'], $edit[$field['drupal'] . '[und][0][value]'], t('The :field Drupal field value was correctly saved.', array(':field' => $field['drupal'])));
        $this->assertEqual($ldap_user->{$field['ldap']}[0], $edit[$field['drupal'] . '[und][0][value]'], t('The :field LDAP attribute was correctly saved.', array(':field' => $field['ldap'])));
      }
    }
  }

}
