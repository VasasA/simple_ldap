<?php
/**
 * @file
 * simple_ldap_user module installation.
 */

/**
 * Implements hook_enable().
 */
function simple_ldap_user_enable() {
  variable_set('password_inc', drupal_get_path('module', 'simple_ldap_user') . '/simple_ldap_user.password.inc');
}

/**
 * Implements hook_disable().
 */
function simple_ldap_user_disable() {
  $password_inc = drupal_get_path('module', 'simple_ldap_user') . '/simple_ldap_user.password.inc';
  if (settings_get('password_inc', 'core/includes/password.inc') == $password_inc) {
    $GLOBALS['settings']['password_inc'] = 'core/includes/password.inc';
  }
}

/**
 * Implements hook_uninstall().
 */
function simple_ldap_user_uninstall() {
  $config = config('simple_ldap_user.settings');
  $config->clear('simple_ldap_user_basedn');
  $config->clear('simple_ldap_user_scope');
  $config->clear('simple_ldap_user_objectclass');
  $config->clear('simple_ldap_user_attribute_name');
  $config->clear('simple_ldap_user_attribute_mail');
  $config->clear('simple_ldap_user_attribute_pass');
  $config->clear('simple_ldap_user_attribute_rdn');
  $config->clear('simple_ldap_user_password_hash');
  $config->clear('simple_ldap_user_filter');
  $config->clear('simple_ldap_user_source');
  $config->clear('simple_ldap_user_sync');
  $config->save();
}

/**
 * Implements hook_requirements().
 */
function simple_ldap_user_requirements($phase) {
  $requirements = array();
  // Ensure translations don't break during installation.
  $t = get_t();

  if ($phase == 'runtime') {
    $expected = drupal_get_path('module', 'simple_ldap_user') . '/simple_ldap_user.password.inc';
    $password_inc = settings_get('password_inc', 'core/includes/password.inc');
    $requirements['password_inc'] = array(
      'title' => 'password_inc',
      'value' => $password_inc,
      'severity' => $password_inc == $expected ? REQUIREMENT_OK : REQUIREMENT_ERROR,
      'description' => $t('Simple LDAP User requires overrides to some of the Drupal password hashing functions.') . ' ' . $t('If the password_inc variable is not set to the file provided by Simple LDAP User, LDAP authentication will not work.'),
    );
  }

  return $requirements;
}
